#!/bin/bash
set -e

# Create system user if it doesn't exist
if ! id -u utnexus >/dev/null 2>&1; then
    useradd --system --no-create-home --shell /usr/sbin/nologin utnexus
fi

# Create directories
mkdir -p /etc/ultimate-terminal
mkdir -p /var/lib/ultimate-terminal
chmod 755 /etc/ultimate-terminal
chown utnexus:utnexus /var/lib/ultimate-terminal
chmod 750 /var/lib/ultimate-terminal

# Create default config if not exists
if [ ! -f /etc/ultimate-terminal/nexus.env ]; then
    # Generate random secrets
    JWT_SECRET=$(openssl rand -hex 48 2>/dev/null || head -c 96 /dev/urandom | base64 | tr -d '\n' | head -c 96)
    WORKER_TOKEN=$(openssl rand -hex 32 2>/dev/null || head -c 64 /dev/urandom | base64 | tr -d '\n' | head -c 64)
    
    cat > /etc/ultimate-terminal/nexus.env << EOF
# Ultimate Terminal Nexus Configuration
# Edit this file and restart the service

# Port to listen on
PORT=3002

# Allowed client origins (comma-separated, or * for all)
CLIENT_ORIGIN=*

# JWT secret for client authentication (auto-generated)
NEXUS_JWT_SECRET=${JWT_SECRET}

# Worker authentication token (share with workers)
WORKER_TOKEN=${WORKER_TOKEN}

# Initial admin password (only used on first run)
# ADMIN_PASSWORD=your-secure-password

# Setup token for remote initial setup (optional)
# NEXUS_SETUP_TOKEN=

# Allow workers without token (NOT recommended for production)
# ALLOW_UNAUTHENTICATED_WORKERS=false
EOF
    chmod 600 /etc/ultimate-terminal/nexus.env
    chown utnexus:utnexus /etc/ultimate-terminal/nexus.env
fi

# Enable and start service
systemctl daemon-reload
systemctl enable ultimate-terminal-nexus.service || true

echo ""
echo "╔══════════════════════════════════════════════════════════════╗"
echo "║          Ultimate Terminal Nexus installed!                  ║"
echo "╠══════════════════════════════════════════════════════════════╣"
echo "║  1. Review configuration:                                    ║"
echo "║     sudo cat /etc/ultimate-terminal/nexus.env                ║"
echo "║                                                              ║"
echo "║  2. Get WORKER_TOKEN for workers:                            ║"
echo "║     sudo grep WORKER_TOKEN /etc/ultimate-terminal/nexus.env  ║"
echo "║                                                              ║"
echo "║  3. Start the service:                                       ║"
echo "║     sudo systemctl start ultimate-terminal-nexus             ║"
echo "║                                                              ║"
echo "║  4. Access web UI at http://localhost:3002                   ║"
echo "║                                                              ║"
echo "║  5. View logs:                                               ║"
echo "║     sudo journalctl -u ultimate-terminal-nexus -f            ║"
echo "╚══════════════════════════════════════════════════════════════╝"
echo ""

exit 0
